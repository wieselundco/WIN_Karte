---
title: "Untitled"
output: 
  html_document: default
---

```{r}
knitr::opts_chunk$set(echo = FALSE)
```


```{r}
library(dplyr)
library(readr)
library(tidyr)
library(sf)
library(stringr)


gemeinden <- st_read("data/gemeinden.gpkg", query = "SELECT name as projektperimeter_gemeinde, kantonsnummer, bezirksnummer, geom FROM gemeinden;")

projekte <- read_csv("data/Projekte_nach_Gemeinde.xlsx - Projekte.csv") %>%
  janitor::clean_names()

projekte_meta <- read_csv("data/Projekte_nach_Gemeinde.xlsx - Zusatzinfo.csv") %>%
  janitor::clean_names() %>%
  mutate(
    projektbezeichnung = case_when(
      projektbezeichnung == "Gantrisch"~"Naturpark Gantrisch",
      projektbezeichnung == "Parc du Doubs"~"Parc de Doubs",
      projektbezeichnung == "Réseaux La Frontière"~"Réseaux Frontière",
      TRUE~projektbezeichnung
    )
  )


projekte <- left_join(projekte, projekte_meta, by = "projektbezeichnung")

anti_join(projekte,gemeinden, by = "projektperimeter_gemeinde") %>%
  select(projektbezeichnung, projektperimeter_gemeinde)

# dni$meintest_du <- adist(dni$projektperimeter_gemeinde,gemeinden$projektperimeter_gemeinde) %>% 
#   apply(1, function(x){gemeinden$projektperimeter_gemeinde[which.min(x)]})


gemeinden_projekte <- gemeinden %>% 
  left_join(projekte, by = "projektperimeter_gemeinde") %>%
  filter(!is.na(projektbezeichnung)) %>%
  st_zm()


```


```{r}
gemeinden_projekte2 <- gemeinden_projekte %>% 
  select(-kantonsnummer, -bezirksnummer) %>%
  relocate(projektbezeichnung)



mymap <- tm_shape(gemeinden_projekte2, name = "Projekte") + 
  tm_polygons(alpha = 0.5, col = "projektbezeichnung",legend.show = TRUE,)

mymap
tmap::tmap_save(mymap, "docs/index.html")
```


```{r}
# render_report <- function(projektbezeichnung) {
# 
#   out_file <- file.path("docs",paste0(make.names(projektbezeichnung),".html"))
# 
#   parameters <- list(projektbezeichnung = projektbezeichnung)
# 
#   rmarkdown::render("param.Rmd", output_file = out_file, params = parameters)
#   invisible(TRUE)
# }
# 
# map(unique(gemeinden_projekte$projektbezeichnung), ~render_report(.x))
# 
# rmarkdown::render("index.Rmd",output_file = "docs/index.html")

```


